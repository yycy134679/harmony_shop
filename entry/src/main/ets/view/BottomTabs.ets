// 202506120141 æ¨å¯Œæ¶›
// åº•éƒ¨å¯¼èˆªæ å®¹å™¨ç»„ä»¶ï¼Œç”¨äºæ˜¾ç¤ºåº”ç”¨çš„ä¸»å¯¼èˆªå®¹å™¨

import { Constants } from '../common/Constants';
import { CartItem } from '../model/CartItem';
import { IndexContent } from './IndexContent';
import { CartContent } from './CartContent';
import { ProfileContent } from './ProfileContent';
import router from '@ohos.router';

/**
 * åº•éƒ¨å¯¼èˆªæ å®¹å™¨ç»„ä»¶ - åº”ç”¨çš„ä¸»å¯¼èˆªå®¹å™¨
 */
@Entry
@Component
struct BottomTabs {
  @StorageLink(Constants.SHOPPING_CART) cartItems: CartItem[] = [];
  @State currentIndex: number = 0;

  /**
   * è®¡ç®—è´­ç‰©è½¦ä¸­å•†å“æ€»æ•°é‡
   */
  private getCartTotalQuantity(): number {
    return this.cartItems.reduce((total, item) => total + item.quantity, 0);
  }

  build() {
    Tabs({ barPosition: BarPosition.End, index: this.currentIndex }) {
      // é¦–é¡µæ ‡ç­¾
      TabContent() {
        IndexContent()
      }
      .tabBar(this.TabBuilder('é¦–é¡µ', 0, null))

      // è´­ç‰©è½¦æ ‡ç­¾
      TabContent() {
        CartContent()
      }
      .tabBar(this.TabBuilder('è´­ç‰©è½¦', 1, null, this.getCartTotalQuantity()))

      // æˆ‘çš„æ ‡ç­¾
      TabContent() {
        ProfileContent()
      }
      .tabBar(this.TabBuilder('æˆ‘çš„', 2, null))
    }
    .onChange((index: number) => {
      this.currentIndex = index;
    })
  }

  /**
   * æ„å»ºæ ‡ç­¾æ é¡¹
   */
  @Builder
  TabBuilder(title: string, targetIndex: number, icon: Resource | null, badgeCount?: number) {
    Column() {
      Stack() {
        // ä½¿ç”¨æ–‡å­—å›¾æ ‡æ›¿ä»£ç³»ç»Ÿå›¾æ ‡
        Text(this.getTabIcon(title))
          .fontSize(20)
          .fontColor(this.currentIndex === targetIndex ? '#ff6b35' : '#999')

        // è´­ç‰©è½¦å¾½ç« 
        if (badgeCount && badgeCount > 0) {
          Text(badgeCount > 99 ? '99+' : badgeCount.toString())
            .fontSize(10)
            .fontColor('#fff')
            .backgroundColor('#E41F19')
            .borderRadius(10)
            .padding({ left: 6, right: 6, top: 2, bottom: 2 })
            .position({ x: 14, y: -6 })
            .width(20)
            .textAlign(TextAlign.Center)
        }
      }
      .margin({ bottom: 4 })

      Text(title)
        .fontSize(12)
        .fontColor(this.currentIndex === targetIndex ? '#ff6b35' : '#999')
    }
    .width('100%')
    .height(56)
    .justifyContent(FlexAlign.Center)
  }

  /**
   * è·å–æ ‡ç­¾é¡µå›¾æ ‡
   */
  private getTabIcon(title: string): string {
    switch (title) {
      case 'é¦–é¡µ':
        return 'ğŸ ';
      case 'è´­ç‰©è½¦':
        return 'ğŸ›’';
      case 'æˆ‘çš„':
        return 'ğŸ‘¤';
      default:
        return 'â€¢';
    }
  }
}
