import router from '@ohos.router';
import { Constants } from '../common/Constants';
import { UserViewModel } from '../viewmodel/UserViewModel';
import { ProfileViewModel } from '../viewmodel/ProfileViewModel';
import { User } from '../model/User';
import { Address } from '../model/Address';
import common from '@ohos.app.ability.common';

/**
 * ‰∏™‰∫∫‰∏≠ÂøÉÂÜÖÂÆπÁªÑ‰ª∂
 */
@Component
export struct ProfileContent {
  @StorageLink(Constants.IS_LOGGED_IN) isLoggedIn: boolean = false;
  @StorageLink(Constants.CURRENT_USER) currentUser: string = '';
  @State userInfo: User | null = null;
  @State defaultAddress: Address | null = null;
  @State isLoading: boolean = false;
  private userViewModel: UserViewModel = new UserViewModel();
  private profileViewModel: ProfileViewModel = new ProfileViewModel();

  async aboutToAppear() {
    try {
      await this.profileViewModel.init(getContext(this) as common.UIAbilityContext);
      if (this.isLoggedIn) {
        await this.loadUserData();
      }
    } catch (error) {
      console.error('Failed to initialize ProfileContent:', error);
    }
  }

  /**
   * Âä†ËΩΩÁî®Êà∑Êï∞ÊçÆ
   */
  private async loadUserData(): Promise<void> {
    if (this.isLoading) return;

    this.isLoading = true;
    try {
      // Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØ
      this.userInfo = await this.profileViewModel.getCurrentUserInfo();
      // Ëé∑ÂèñÈªòËÆ§Âú∞ÂùÄ
      this.defaultAddress = await this.profileViewModel.getDefaultAddress();
    } catch (error) {
      console.error('Failed to load user data:', error);
    } finally {
      this.isLoading = false;
    }
  }

  /**
   * Â§ÑÁêÜÈÄÄÂá∫ÁôªÂΩï
   */
  private handleLogout(): void {
    this.userViewModel.logout();
    // ÂèØ‰ª•ÈÄâÊã©Ë∑≥ËΩ¨Âà∞È¶ñÈ°µÊ†áÁ≠æ
  }

  /**
   * Ë∑≥ËΩ¨Âà∞ÁôªÂΩïÈ°µÈù¢
   */
  private goToLogin(): void {
    router.pushUrl({ url: 'pages/LoginPage' });
  }

  /**
   * Ë∑≥ËΩ¨Âà∞ÁºñËæë‰∏™‰∫∫‰ø°ÊÅØÈ°µÈù¢
   */
  private goToEditProfile(): void {
    router.pushUrl({ url: 'pages/EditProfilePage' });
  }

  /**
   * Ë∑≥ËΩ¨Âà∞ÊàëÁöÑÊî∂ËóèÈ°µÈù¢
   */
  private goToFavorites(): void {
    router.pushUrl({ url: 'pages/FavoriteListPage' });
  }

  /**
   * Ë∑≥ËΩ¨Âà∞Âú∞ÂùÄÁÆ°ÁêÜÈ°µÈù¢
   */
  private goToAddressManagement(): void {
    router.pushUrl({ url: 'pages/AddressManagementPage' });
  }

  /**
   * Ë∑≥ËΩ¨Âà∞ÊàëÁöÑËÆ¢ÂçïÈ°µÈù¢
   */
  private goToOrders(): void {
    router.pushUrl({ url: 'pages/OrderListPage' });
  }

  build() {
    Column() {
      if (this.isLoggedIn) {
        // Â∑≤ÁôªÂΩïÁä∂ÊÄÅ
        this.buildLoggedInContent()
      } else {
        // Êú™ÁôªÂΩïÁä∂ÊÄÅ
        this.buildNotLoggedInContent()
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f5f5f5')
    .onAppear(() => {
      // ÂΩìÁªÑ‰ª∂ÊòæÁ§∫Êó∂ÔºåÂ¶ÇÊûúÂ∑≤ÁôªÂΩïÂàôÂä†ËΩΩÁî®Êà∑Êï∞ÊçÆ
      if (this.isLoggedIn) {
        this.loadUserData();
      }
    })
  }

  /**
   * ÊûÑÂª∫Â∑≤ÁôªÂΩïÁä∂ÊÄÅÁöÑÂÜÖÂÆπ
   */
  @Builder
  buildLoggedInContent() {
    Column() {
      // Áî®Êà∑‰ø°ÊÅØÂå∫Âüü
      Column() {
        // Â§¥ÂÉè
        Text('üë§')
          .fontSize(60)
          .margin({ bottom: 12 })

        // Áî®Êà∑Âêç
        Text(this.currentUser)
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333')
          .margin({ bottom: 8 })

        // ‰∏™‰∫∫‰ø°ÊÅØÂ±ïÁ§∫Âå∫Âüü
        if (this.userInfo?.phone) {
          Text(`ÁîµËØùÔºö${this.userInfo.phone}`)
            .fontSize(14)
            .fontColor('#666')
            .margin({ bottom: 4 })
        } else {
          Text('ÁîµËØùÔºöÊú™ËÆæÁΩÆ')
            .fontSize(14)
            .fontColor('#999')
            .margin({ bottom: 4 })
        }

        if (this.defaultAddress) {
          Text(`ÈªòËÆ§Âú∞ÂùÄÔºö${this.defaultAddress.fullAddress}`)
            .fontSize(14)
            .fontColor('#666')
            .maxLines(2)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
        } else {
          Text('ÈªòËÆ§Âú∞ÂùÄÔºöÊú™ËÆæÁΩÆ')
            .fontSize(14)
            .fontColor('#999')
        }
      }
      .width('100%')
      .padding(24)
      .backgroundColor('#fff')
      .margin({ bottom: 12 })

      // ÂäüËÉΩËèúÂçïÂå∫Âüü
      Column() {
        this.buildMenuItemText('ÊàëÁöÑËÆ¢Âçï', 'ËÆ¢Âçï', () => this.goToOrders())
        Divider().color('#f0f0f0')
        this.buildMenuItemText('ÊàëÁöÑÊî∂Ëóè', 'Êî∂Ëóè', () => this.goToFavorites())
        Divider().color('#f0f0f0')
        this.buildMenuItemText('Âú∞ÂùÄÁÆ°ÁêÜ', 'Âú∞ÂùÄ', () => this.goToAddressManagement())
        Divider().color('#f0f0f0')
        this.buildMenuItemText('‰øÆÊîπ‰ø°ÊÅØ', 'ÁºñËæë', () => this.goToEditProfile())
      }
      .backgroundColor('#fff')
      .borderRadius(8)
      .margin({ left: 16, right: 16, bottom: 24 })

      // ÈÄÄÂá∫ÁôªÂΩïÊåâÈíÆ
      Button('ÈÄÄÂá∫ÁôªÂΩï')
        .width('calc(100% - 32vp)')
        .height(48)
        .backgroundColor('#ff4444')
        .fontColor('#fff')
        .fontSize(16)
        .borderRadius(8)
        .onClick(() => this.handleLogout())
    }
    .width('100%')
    .height('100%')
  }

  /**
   * ÊûÑÂª∫Êú™ÁôªÂΩïÁä∂ÊÄÅÁöÑÂÜÖÂÆπ
   */
  @Builder
  buildNotLoggedInContent() {
    Column() {
      // Êú™ÁôªÂΩïÊèêÁ§∫Âå∫Âüü
      Column() {
        Text('üë§')
          .fontSize(60)
          .fontColor('#ccc')
          .margin({ bottom: 16 })

        Text('ÊÇ®ËøòÊú™ÁôªÂΩï')
          .fontSize(18)
          .fontColor('#666')
          .margin({ bottom: 8 })

        Text('ÁôªÂΩïÂêéÂèØ‰∫´ÂèóÊõ¥Â§öÊúçÂä°')
          .fontSize(14)
          .fontColor('#999')
          .margin({ bottom: 24 })

        Button('Á´ãÂç≥ÁôªÂΩï')
          .width(120)
          .height(40)
          .backgroundColor('#ff6b35')
          .fontColor('#fff')
          .fontSize(16)
          .borderRadius(20)
          .onClick(() => this.goToLogin())
      }
      .width('100%')
      .padding(48)
      .backgroundColor('#fff')
      .justifyContent(FlexAlign.Center)
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
  }

  /**
   * ÊûÑÂª∫ËèúÂçïÈ°πÔºàÊñáÂ≠óÁâàÊú¨Ôºâ
   */
  @Builder
  buildMenuItemText(title: string, iconText: string, onClick: () => void) {
    Row() {
      Text(iconText)
        .width(32)
        .height(32)
        .fontSize(14)
        .fontColor('#ff6b35')
        .fontWeight(FontWeight.Medium)
        .textAlign(TextAlign.Center)
        .backgroundColor('#fff2f0')
        .borderRadius(16)
        .margin({ right: 12 })

      Text(title)
        .fontSize(16)
        .fontColor('#333')
        .layoutWeight(1)

      Text('>')
        .fontSize(16)
        .fontColor('#ccc')
    }
    .width('100%')
    .height(56)
    .padding({ left: 16, right: 16 })
    .onClick(onClick)
  }

  /**
   * ÊûÑÂª∫ËèúÂçïÈ°πÔºàÂéüÁâàÊú¨‰øùÁïôÔºâ
   */
  @Builder
  buildMenuItem(title: string, icon: Resource, onClick: () => void) {
    Row() {
      Image(icon)
        .width(24)
        .height(24)
        .fillColor('#666')
        .margin({ right: 12 })

      Text(title)
        .fontSize(16)
        .fontColor('#333')
        .layoutWeight(1)

      Text('>')
        .fontSize(16)
        .fontColor('#ccc')
    }
    .width('100%')
    .height(56)
    .padding({ left: 16, right: 16 })
    .onClick(onClick)
  }
}
