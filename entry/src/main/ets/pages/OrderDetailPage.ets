import router from '@ohos.router';
import { Order } from '../model/Order';
import { OrderItem as OrderItemModel } from '../model/OrderItem';
import { OrderViewModel } from '../viewmodel/OrderViewModel';

/**
 * è®¢å•è¯¦æƒ…é¡µé¢
 */
@Entry
@Component
struct OrderDetailPage {
  @State order: Order | null = null;
  private orderViewModel: OrderViewModel = new OrderViewModel();

  aboutToAppear() {
    // è·å–ä¼ å…¥çš„è®¢å•ä¿¡æ¯
    const params = router.getParams() as Record<string, Object>;
    if (params && params.order) {
      this.order = params.order as Order;
    }
  }

  build() {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        Button() {
          Text('â†')
            .fontSize(20)
            .fontColor('#333')
            .fontWeight(FontWeight.Bold)
        }
        .width(40)
        .height(40)
        .backgroundColor('#f0f0f0')
        .borderRadius(20)
        .onClick(() => router.back())

        Text('è®¢å•è¯¦æƒ…')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333')
          .layoutWeight(1)
          .textAlign(TextAlign.Center)

        // å ä½ï¼Œä¿æŒæ ‡é¢˜å±…ä¸­
        Row().width(40).height(40)
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#fff')

      if (this.order) {
        Scroll() {
          Column() {
            // è®¢å•çŠ¶æ€
            Column() {
              Row() {
                Text('âœ“')
                  .fontSize(20)
                  .fontColor(this.orderViewModel.getStatusColor(this.order.status))
                  .fontWeight(FontWeight.Bold)
                  .margin({ right: 12 })

                Column() {
                  Text(this.orderViewModel.getStatusDisplayText(this.order.status))
                    .fontSize(18)
                    .fontWeight(FontWeight.Bold)
                    .fontColor('#333')
                    .width('100%')
                    .textAlign(TextAlign.Start)
                    .margin({ bottom: 4 })

                  Text(this.orderViewModel.formatOrderTime(this.order.createTime))
                    .fontSize(14)
                    .fontColor('#666')
                    .width('100%')
                    .textAlign(TextAlign.Start)
                }
                .layoutWeight(1)
                .alignItems(HorizontalAlign.Start)
              }
              .width('100%')
            }
            .width('100%')
            .padding(20)
            .backgroundColor('#fff')
            .margin({ top: 12, left: 16, right: 16 })
            .borderRadius(8)

            // æ”¶è´§åœ°å€
            Column() {
              Row() {
                Text('ğŸ ')
                  .fontSize(16)
                  .margin({ right: 8 })

                Text('æ”¶è´§åœ°å€')
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)
                  .fontColor('#333')
              }
              .width('100%')
              .margin({ bottom: 12 })

              Column() {
                Row() {
                  Text(this.order.shippingAddress.recipientName)
                    .fontSize(16)
                    .fontColor('#333')
                    .margin({ right: 12 })

                  Text(this.order.shippingAddress.phone)
                    .fontSize(14)
                    .fontColor('#666')
                }
                .width('100%')
                .margin({ bottom: 8 })

                Text(this.order.shippingAddress.fullAddress)
                  .fontSize(14)
                  .fontColor('#666')
                  .width('100%')
                  .textAlign(TextAlign.Start)
              }
              .alignItems(HorizontalAlign.Start)
            }
            .width('100%')
            .padding(16)
            .backgroundColor('#fff')
            .margin({ top: 12, left: 16, right: 16 })
            .borderRadius(8)

            // å•†å“åˆ—è¡¨
            Column() {
              Row() {
                Text('ğŸ›ï¸')
                  .fontSize(16)
                  .margin({ right: 8 })

                Text('å•†å“æ¸…å•')
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)
                  .fontColor('#333')
              }
              .width('100%')
              .margin({ bottom: 12 })

              ForEach(this.order.items, (item: OrderItemModel) => {
                Row() {
                  Stack({ alignContent: Alignment.Center }) {
                    Image(this.orderViewModel.getProductImageUrl(item.productId))
                      .width(60)
                      .height(60)
                      .objectFit(ImageFit.Contain)
                      .backgroundColor('#FFFFFF')
                      .onError(() => {
                        console.error(`Failed to load product image for ID: ${item.productId}`);
                      })
                  }
                  .width(60)
                  .height(60)
                  .backgroundColor('#f9f9f9')
                  .borderRadius(8)
                  .margin({ right: 12 })

                  Column() {
                    Text(item.name)
                      .fontSize(14)
                      .fontColor('#333')
                      .maxLines(2)
                      .textOverflow({ overflow: TextOverflow.Ellipsis })
                      .width('100%')
                      .margin({ bottom: 4 })

                    Row() {
                      Text(`Â¥${item.price.toFixed(2)}`)
                        .fontSize(16)
                        .fontColor('#E41F19')
                        .fontWeight(FontWeight.Medium)

                      Blank()

                      Text(`x${item.quantity}`)
                        .fontSize(14)
                        .fontColor('#666')
                    }
                    .width('100%')
                  }
                  .layoutWeight(1)
                  .alignItems(HorizontalAlign.Start)
                }
                .width('100%')
                .padding({ top: 12, bottom: 12 })
                .border({ width: { bottom: 1 }, color: '#f0f0f0' })
              }, (item: OrderItemModel) => `${item.productId}`)
            }
            .width('100%')
            .padding(16)
            .backgroundColor('#fff')
            .margin({ top: 12, left: 16, right: 16 })
            .borderRadius(8)

            // è®¢å•ä¿¡æ¯
            Column() {
              Row() {
                Text('è®¢å•å·')
                  .fontSize(14)
                  .fontColor('#666')
                  .width(80)

                Text(this.order.orderId)
                  .fontSize(14)
                  .fontColor('#333')
                  .layoutWeight(1)
              }
              .width('100%')
              .margin({ bottom: 12 })

              Row() {
                Text('æ”¯ä»˜æ–¹å¼')
                  .fontSize(14)
                  .fontColor('#666')
                  .width(80)

                Text(this.order.paymentMethod)
                  .fontSize(14)
                  .fontColor('#333')
                  .layoutWeight(1)
              }
              .width('100%')
              .margin({ bottom: 12 })

              Row() {
                Text('å•†å“æ€»ä»·')
                  .fontSize(14)
                  .fontColor('#666')
                  .width(80)

                Text(`Â¥${this.order.totalPrice.toFixed(2)}`)
                  .fontSize(14)
                  .fontColor('#333')
                  .layoutWeight(1)
              }
              .width('100%')
              .margin({ bottom: 12 })

              Row() {
                Text('è¿è´¹')
                  .fontSize(14)
                  .fontColor('#666')
                  .width(80)

                Text('å…è¿è´¹')
                  .fontSize(14)
                  .fontColor('#4CAF50')
                  .layoutWeight(1)
              }
              .width('100%')
              .margin({ bottom: 12 })

              Divider().color('#f0f0f0').margin({ bottom: 12 })

              Row() {
                Text('å®ä»˜æ¬¾')
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)
                  .fontColor('#333')
                  .width(80)

                Text(`Â¥${this.order.totalPrice.toFixed(2)}`)
                  .fontSize(18)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#E41F19')
                  .layoutWeight(1)
              }
              .width('100%')
            }
            .width('100%')
            .padding(16)
            .backgroundColor('#fff')
            .margin({ top: 12, left: 16, right: 16, bottom: 20 })
            .borderRadius(8)
          }
        }
        .layoutWeight(1)
      } else {
        // è®¢å•ä¸å­˜åœ¨
        Column() {
          Text('è®¢å•ä¸å­˜åœ¨')
            .fontSize(16)
            .fontColor('#999')
          
          Button('è¿”å›')
            .margin({ top: 20 })
            .onClick(() => {
              router.back();
            })
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f5f5f5')
  }
}
