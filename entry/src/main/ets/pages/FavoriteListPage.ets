import router from '@ohos.router';
import { FavoriteViewModel } from '../viewmodel/FavoriteViewModel';
import { Product } from '../model/Product';
import promptAction from '@ohos.promptAction';
import common from '@ohos.app.ability.common';

/**
 * æˆ‘çš„æ”¶è—é¡µé¢
 */
@Entry
@Component
struct FavoriteListPage {
  @State favoriteProducts: Product[] = [];
  @State isLoading: boolean = true;
  private favoriteViewModel: FavoriteViewModel = new FavoriteViewModel();

  async aboutToAppear() {
    try {
      await this.favoriteViewModel.init(getContext(this) as common.UIAbilityContext);
      await this.loadFavoriteProducts();
    } catch (error) {
      console.error('Failed to initialize FavoriteListPage:', error);
    }
  }

  /**
   * åŠ è½½æ”¶è—å•†å“åˆ—è¡¨
   */
  private async loadFavoriteProducts(): Promise<void> {
    this.isLoading = true;
    try {
      this.favoriteProducts = await this.favoriteViewModel.getFavoriteProducts();
    } catch (error) {
      console.error('Failed to load favorite products:', error);
    } finally {
      this.isLoading = false;
    }
  }

  /**
   * å–æ¶ˆæ”¶è—
   */
  private async removeFavorite(productId: number): Promise<void> {
    try {
      const result = await this.favoriteViewModel.removeFavorite(productId);
      if (result.success) {
        promptAction.showToast({
          message: result.message,
          duration: 2000
        });
        // é‡æ–°åŠ è½½æ”¶è—åˆ—è¡¨
        await this.loadFavoriteProducts();
      } else {
        promptAction.showToast({
          message: result.message,
          duration: 2000
        });
      }
    } catch (error) {
      console.error('Failed to remove favorite:', error);
      promptAction.showToast({
        message: 'æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•',
        duration: 2000
      });
    }
  }

  /**
   * è·³è½¬åˆ°å•†å“è¯¦æƒ…é¡µ
   */
  private goToProductDetail(productId: number): void {
    router.pushUrl({
      url: 'pages/DetailsPage',
      params: { productId: productId }
    });
  }

  build() {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        Button() {
          Text('â†')
            .fontSize(20)
            .fontColor('#333')
            .fontWeight(FontWeight.Bold)
        }
        .width(40)
        .height(40)
        .backgroundColor('#f0f0f0')
        .borderRadius(20)
        .onClick(() => router.back())

        Text('æˆ‘çš„æ”¶è—')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333')
          .layoutWeight(1)
          .textAlign(TextAlign.Center)

        // å ä½ï¼Œä¿æŒæ ‡é¢˜å±…ä¸­
        Row().width(40).height(40)
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#fff')

      if (this.isLoading) {
        // åŠ è½½çŠ¶æ€
        Column() {
          LoadingProgress()
            .width(40)
            .height(40)
            .color('#ff6b35')
          
          Text('åŠ è½½ä¸­...')
            .fontSize(14)
            .fontColor('#666')
            .margin({ top: 12 })
        }
        .width('100%')
        .height('60%')
        .justifyContent(FlexAlign.Center)
      } else if (this.favoriteProducts.length === 0) {
        // ç©ºçŠ¶æ€
        Column() {
          Text('ğŸ’')
            .fontSize(60)
            .margin({ bottom: 16 })

          Text('æš‚æ— æ”¶è—å•†å“')
            .fontSize(16)
            .fontColor('#666')
            .margin({ bottom: 8 })

          Text('å»é¦–é¡µçœ‹çœ‹æœ‰ä»€ä¹ˆå¥½å•†å“å§')
            .fontSize(14)
            .fontColor('#999')
            .margin({ bottom: 24 })

          Button('å»é€›é€›')
            .width(120)
            .height(40)
            .backgroundColor('#ff6b35')
            .fontColor('#fff')
            .fontSize(16)
            .borderRadius(20)
            .onClick(() => {
              router.back();
            })
        }
        .width('100%')
        .height('60%')
        .justifyContent(FlexAlign.Center)
      } else {
        // æ”¶è—å•†å“åˆ—è¡¨
        List({ space: 12 }) {
          ForEach(this.favoriteProducts, (product: Product) => {
            ListItem() {
              this.buildFavoriteItem(product)
            }
          }, (product: Product) => product.id.toString())
        }
        .layoutWeight(1)
        .padding({ left: 16, right: 16, top: 12, bottom: 12 })
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f5f5f5')
  }

  /**
   * æ„å»ºæ”¶è—å•†å“é¡¹
   */
  @Builder
  buildFavoriteItem(product: Product) {
    Row() {
      // å•†å“å›¾ç‰‡
      Image(product.image)
        .width(80)
        .height(80)
        .objectFit(ImageFit.Contain)
        .backgroundColor('#f9f9f9')
        .borderRadius(8)
        .margin({ right: 12 })

      // å•†å“ä¿¡æ¯
      Column() {
        Text(product.name)
          .fontSize(16)
          .fontColor('#333')
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .margin({ bottom: 8 })
          .textAlign(TextAlign.Start)
          .width('100%')

        Text(`Â¥${product.price.toFixed(2)}`)
          .fontSize(18)
          .fontColor('#E41F19')
          .fontWeight(FontWeight.Bold)
          .margin({ bottom: 8 })
          .textAlign(TextAlign.Start)
          .width('100%')

        Row() {
          Button('æŸ¥çœ‹è¯¦æƒ…')
            .height(32)
            .backgroundColor('#ff6b35')
            .fontColor('#fff')
            .fontSize(14)
            .borderRadius(16)
            .padding({ left: 16, right: 16 })
            .onClick(() => this.goToProductDetail(product.id))

          Blank()

          Button('å–æ¶ˆæ”¶è—')
            .height(32)
            .backgroundColor('transparent')
            .fontColor('#666')
            .fontSize(14)
            .border({ width: 1, color: '#ddd' })
            .borderRadius(16)
            .padding({ left: 16, right: 16 })
            .onClick(() => {
              AlertDialog.show({
                title: 'ç¡®è®¤å–æ¶ˆæ”¶è—',
                message: `ç¡®å®šè¦å–æ¶ˆæ”¶è—"${product.name}"å—ï¼Ÿ`,
                primaryButton: {
                  value: 'ç¡®å®š',
                  action: () => {
                    this.removeFavorite(product.id);
                  }
                },
                secondaryButton: {
                  value: 'å–æ¶ˆ',
                  action: () => {}
                }
              });
            })
        }
        .width('100%')
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#fff')
    .borderRadius(8)
    .onClick(() => this.goToProductDetail(product.id))
  }
}
