//202306110141 æ¨å¯Œæ¶›
//åœ°å€é€‰æ‹©é¡µé¢ - ç”¨äºåœ¨ä¸‹å•æ—¶é€‰æ‹©æ”¶è´§åœ°å€ï¼Œæ”¯æŒé€‰æ‹©å·²æœ‰åœ°å€æˆ–æ·»åŠ æ–°åœ°å€

import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import { AddressViewModel } from '../viewmodel/AddressViewModel';
import { AddressItem } from '../view/AddressItem';
import { Address } from '../model/Address';
import common from '@ohos.app.ability.common';

/**
 * åœ°å€é€‰æ‹©é¡µé¢
 * ç”¨äºåœ¨è®¢å•ç¡®è®¤è¿‡ç¨‹ä¸­é€‰æ‹©æ”¶è´§åœ°å€
 */
@Entry
@Component
struct AddressSelectionPage {
  @State addresses: Address[] = [];          // åœ°å€åˆ—è¡¨
  @State isLoading: boolean = true;          // åŠ è½½çŠ¶æ€
  @State selectedAddressId: string = '';     // å½“å‰é€‰ä¸­çš„åœ°å€ID
  private addressViewModel: AddressViewModel = new AddressViewModel(); // åœ°å€æ•°æ®è§†å›¾æ¨¡å‹

  /**
   * ç»„ä»¶å³å°†å‡ºç°æ—¶çš„ç”Ÿå‘½å‘¨æœŸå‡½æ•°
   * åˆå§‹åŒ–è§†å›¾æ¨¡å‹ï¼Œè·å–å·²é€‰åœ°å€IDï¼Œå¹¶åŠ è½½åœ°å€åˆ—è¡¨
   */
  async aboutToAppear() {
    try {
      await this.addressViewModel.init(getContext(this) as common.UIAbilityContext);
      
      // è·å–ä¼ å…¥çš„å·²é€‰æ‹©åœ°å€ID
      const params = router.getParams() as Record<string, Object>;
      if (params && params.selectedAddressId) {
        this.selectedAddressId = params.selectedAddressId as string;
      }
      
      await this.loadAddresses();
    } catch (error) {
      console.error('Failed to initialize AddressSelectionPage:', error);
      this.isLoading = false;
    }
  }

  /**
   * åŠ è½½åœ°å€åˆ—è¡¨
   * ä»è§†å›¾æ¨¡å‹ä¸­è·å–ç”¨æˆ·çš„æ‰€æœ‰åœ°å€
   */
  private async loadAddresses(): Promise<void> {
    try {
      this.isLoading = true;
      this.addresses = await this.addressViewModel.getAddresses();
    } catch (error) {
      console.error('Failed to load addresses:', error);
      promptAction.showToast({
        message: 'åŠ è½½åœ°å€å¤±è´¥',
        duration: 2000
      });
    } finally {
      this.isLoading = false;
    }
  }

  /**
   * é€‰æ‹©åœ°å€
   * å°†é€‰ä¸­çš„åœ°å€è¿”å›ç»™è®¢å•ç¡®è®¤é¡µé¢
   * @param address é€‰ä¸­çš„åœ°å€å¯¹è±¡
   */
  private selectAddress(address: Address): void {
    router.back({
      url: 'pages/OrderConfirmationPage',
      params: {
        selectedAddress: address
      }
    });
  }

  /**
   * æ–°å¢åœ°å€
   * è·³è½¬åˆ°åœ°å€ç¼–è¾‘é¡µé¢
   */
  private addAddress(): void {
    router.pushUrl({ url: 'pages/AddressEditPage' });
  }

  /**
   * ç¼–è¾‘åœ°å€
   * è·³è½¬åˆ°åœ°å€ç¼–è¾‘é¡µé¢å¹¶ä¼ é€’åœ°å€ä¿¡æ¯
   * @param address éœ€è¦ç¼–è¾‘çš„åœ°å€å¯¹è±¡
   */
  private editAddress(address: Address): void {
    router.pushUrl({ 
      url: 'pages/AddressEditPage',
      params: { address: address }
    });
  }

  /**
   * æ„å»ºUIç•Œé¢
   */
  build() {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        Button() {
          Text('â†')
            .fontSize(20)
            .fontColor('#333')
            .fontWeight(FontWeight.Bold)
        }
        .width(40)
        .height(40)
        .backgroundColor('#f0f0f0')
        .borderRadius(20)
        .onClick(() => router.back()) // è¿”å›ä¸Šä¸€é¡µ

        Text('é€‰æ‹©æ”¶è´§åœ°å€')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333')
          .layoutWeight(1)
          .textAlign(TextAlign.Center)

        // æ–°å¢æŒ‰é’®
        Button() {
          Text('+')
            .fontSize(20)
            .fontColor('#ff6b35')
            .fontWeight(FontWeight.Bold)
        }
        .width(40)
        .height(40)
        .backgroundColor('#f0f0f0')
        .borderRadius(20)
        .onClick(() => this.addAddress()) // ç‚¹å‡»æ·»åŠ æ–°åœ°å€
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#fff')

      if (this.isLoading) {
        // åŠ è½½çŠ¶æ€ - æ˜¾ç¤ºåŠ è½½è¿›åº¦æŒ‡ç¤ºå™¨
        Column() {
          LoadingProgress()
            .width(40)
            .height(40)
            .margin({ bottom: 16 })

          Text('åŠ è½½ä¸­...')
            .fontSize(14)
            .fontColor('#666')
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
      } else if (this.addresses.length === 0) {
        // ç©ºçŠ¶æ€ - æ²¡æœ‰åœ°å€æ—¶æ˜¾ç¤º
        Column() {
          Text('ğŸ ')
            .fontSize(60)
            .fontColor('#ddd')
            .margin({ bottom: 16 })

          Text('æš‚æ— æ”¶è´§åœ°å€')
            .fontSize(16)
            .fontColor('#666')
            .margin({ bottom: 8 })

          Text('ç‚¹å‡»å³ä¸Šè§’"+"æ·»åŠ æ–°åœ°å€')
            .fontSize(14)
            .fontColor('#999')
            .margin({ bottom: 24 })

          Button('æ·»åŠ åœ°å€')
            .width(120)
            .height(40)
            .backgroundColor('#ff6b35')
            .fontColor('#fff')
            .fontSize(16)
            .borderRadius(20)
            .onClick(() => this.addAddress()) // ç‚¹å‡»æ·»åŠ æ–°åœ°å€
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
      } else {
        // åœ°å€åˆ—è¡¨ - æ˜¾ç¤ºæ‰€æœ‰å¯é€‰åœ°å€
        Scroll() {
          Column() {
            ForEach(this.addresses, (address: Address) => {
              Column() {
                Row() {
                  // é€‰æ‹©çŠ¶æ€æŒ‡ç¤ºå™¨ - æ˜¾ç¤ºé€‰ä¸­çŠ¶æ€æˆ–é»˜è®¤çŠ¶æ€
                  Row() {
                    if (this.selectedAddressId === address.id || address.isDefault) {
                      Text('âœ“')
                        .fontSize(16)
                        .fontColor('#ff6b35')
                        .fontWeight(FontWeight.Bold)
                    } else {
                      Text('â—‹')
                        .fontSize(16)
                        .fontColor('#ddd')
                    }
                  }
                  .width(40)
                  .justifyContent(FlexAlign.Center)

                  // åœ°å€ä¿¡æ¯ - æ˜¾ç¤ºæ”¶ä»¶äººã€ç”µè¯å’Œè¯¦ç»†åœ°å€
                  Column() {
                    Row() {
                      Text(address.recipientName)
                        .fontSize(16)
                        .fontWeight(FontWeight.Medium)
                        .fontColor('#333')
                        .margin({ right: 12 })

                      Text(address.phone)
                        .fontSize(14)
                        .fontColor('#666')

                      if (address.isDefault) {
                        Text('é»˜è®¤')
                          .fontSize(12)
                          .fontColor('#fff')
                          .backgroundColor('#ff6b35')
                          .padding({ left: 8, right: 8, top: 2, bottom: 2 })
                          .borderRadius(10)
                          .margin({ left: 12 })
                      }
                    }
                    .width('100%')
                    .margin({ bottom: 8 })

                    Text(address.fullAddress)
                      .fontSize(14)
                      .fontColor('#666')
                      .maxLines(2)
                      .textOverflow({ overflow: TextOverflow.Ellipsis })
                      .width('100%')
                  }
                  .layoutWeight(1)
                  .alignItems(HorizontalAlign.Start)

                  // ç¼–è¾‘æŒ‰é’®
                  Button('ç¼–è¾‘')
                    .fontSize(12)
                    .fontColor('#ff6b35')
                    .backgroundColor('transparent')
                    .border({ width: 1, color: '#ff6b35' })
                    .borderRadius(4)
                    .padding({ left: 12, right: 12, top: 6, bottom: 6 })
                    .onClick(() => this.editAddress(address))
                }
                .width('100%')
                .padding(16)
                .backgroundColor('#fff')
                .borderRadius(8)
                .margin({ bottom: 12 })
                .onClick(() => this.selectAddress(address)) // ç‚¹å‡»é€‰æ‹©è¯¥åœ°å€
              }
            }, (address: Address) => address.id) // ä½¿ç”¨åœ°å€IDä½œä¸ºå”¯ä¸€é”®
          }
          .padding(16)
        }
        .layoutWeight(1)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f5f5f5')
  }
}
