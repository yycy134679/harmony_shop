// 202306110141 æ¨å¯Œæ¶›
// è®¢å•ç¡®è®¤é¡µé¢ - å±•ç¤ºè´­ç‰©è½¦å•†å“ã€æ”¶è´§åœ°å€ã€ä»·æ ¼æ˜ç»†ï¼Œæ”¯æŒé€‰æ‹©æ”¯ä»˜æ–¹å¼å’Œä¸‹å•

import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import { CartViewModel } from '../viewmodel/CartViewModel';
import { CartItem } from '../model/CartItem';
import { Address } from '../model/Address';
import common from '@ohos.app.ability.common';

/**
 * è®¢å•ç¡®è®¤é¡µé¢
 * å±•ç¤ºè´­ç‰©è½¦å•†å“ã€æ”¶è´§åœ°å€ã€ä»·æ ¼æ˜ç»†ï¼Œæ”¯æŒé€‰æ‹©æ”¯ä»˜æ–¹å¼å’Œä¸‹å•
 */
@Entry
@Component
struct OrderConfirmationPage {
  @State cartItems: CartItem[] = []; // è´­ç‰©è½¦å•†å“åˆ—è¡¨
  @State selectedAddress: Address | null = null; // å½“å‰é€‰ä¸­çš„æ”¶è´§åœ°å€
  @State totalPrice: number = 0; // æ€»ä»·
  @State isLoading: boolean = false; // æ”¯ä»˜ä¸­çŠ¶æ€
  @State paymentMethod: 'å¾®ä¿¡æ”¯ä»˜' | 'æ”¯ä»˜å®' | 'äº‘é—ªä»˜' = 'å¾®ä¿¡æ”¯ä»˜'; // æ”¯ä»˜æ–¹å¼
  @State showPaymentDialog: boolean = false; // æ˜¯å¦æ˜¾ç¤ºæ”¯ä»˜æ–¹å¼å¼¹çª—
  private cartViewModel: CartViewModel = new CartViewModel(); // è´­ç‰©è½¦è§†å›¾æ¨¡å‹

  /**
   * ç”Ÿå‘½å‘¨æœŸ aboutToAppear
   * åˆå§‹åŒ–è´­ç‰©è½¦è§†å›¾æ¨¡å‹ï¼ŒåŠ è½½è´­ç‰©è½¦å•†å“ã€é»˜è®¤åœ°å€ã€æ ¡éªŒè´­ç‰©è½¦
   */
  async aboutToAppear() {
    try {
      await this.cartViewModel.init(getContext(this) as common.UIAbilityContext);

      // è·å–è´­ç‰©è½¦å•†å“
      this.cartItems = this.cartViewModel.getCartItems();
      this.totalPrice = this.cartViewModel.getTotalPrice();

      // æ£€æŸ¥æ˜¯å¦æœ‰ä¼ å…¥çš„é€‰ä¸­åœ°å€
      const params = router.getParams() as Record<string, Object>;
      if (params && params.selectedAddress) {
        this.selectedAddress = params.selectedAddress as Address;
      } else {
        // è·å–é»˜è®¤åœ°å€
        this.selectedAddress = await this.cartViewModel.getDefaultAddress();
      }

      // éªŒè¯è´­ç‰©è½¦
      const validation = this.cartViewModel.canCheckout();
      if (!validation.canCheckout) {
        promptAction.showToast({
          message: validation.message,
          duration: 2000
        });
        router.back();
      }
    } catch (error) {
      console.error('Failed to initialize OrderConfirmationPage:', error);
      promptAction.showToast({
        message: 'é¡µé¢åˆå§‹åŒ–å¤±è´¥',
        duration: 2000
      });
      router.back();
    }
  }

  /**
   * è·³è½¬é€‰æ‹©æ”¶è´§åœ°å€é¡µé¢
   */
  private selectAddress(): void {
    router.pushUrl({
      url: 'pages/AddressSelectionPage',
      params: {
        selectedAddressId: this.selectedAddress?.id || ''
      }
    });
  }

  /**
   * æ˜¾ç¤ºæ”¯ä»˜æ–¹å¼é€‰æ‹©å¯¹è¯æ¡†
   */
  private openPaymentDialog(): void {
    if (!this.selectedAddress) {
      promptAction.showToast({
        message: 'è¯·å…ˆé€‰æ‹©æ”¶è´§åœ°å€',
        duration: 2000
      });
      return;
    }
    this.showPaymentDialog = true;
  }

  /**
   * å…³é—­æ”¯ä»˜æ–¹å¼é€‰æ‹©å¯¹è¯æ¡†
   */
  private closePaymentDialog(): void {
    this.showPaymentDialog = false;
  }

  /**
   * é€‰æ‹©æ”¯ä»˜æ–¹å¼
   */
  private selectPaymentMethod(method: 'å¾®ä¿¡æ”¯ä»˜' | 'æ”¯ä»˜å®' | 'äº‘é—ªä»˜'): void {
    this.paymentMethod = method;
  }

  /**
   * å¤„ç†æ”¯ä»˜
   * æ ¡éªŒæ”¶è´§åœ°å€ï¼Œæ¨¡æ‹Ÿæ”¯ä»˜ï¼Œåˆ›å»ºè®¢å•å¹¶è·³è½¬åˆ°æ”¯ä»˜æˆåŠŸé¡µé¢
   */
  private async processPayment(): Promise<void> {
    if (this.isLoading) return;

    if (!this.selectedAddress) {
      promptAction.showToast({
        message: 'è¯·å…ˆé€‰æ‹©æ”¶è´§åœ°å€',
        duration: 2000
      });
      return;
    }

    this.isLoading = true;
    try {
      // æ¨¡æ‹Ÿæ”¯ä»˜å»¶è¿Ÿ
      await new Promise<void>(resolve => setTimeout(resolve, 1500));

      // åˆ›å»ºè®¢å•
      const result = await this.cartViewModel.createOrderAndClearCart(
        this.selectedAddress,
        this.paymentMethod
      );

      if (result.success) {
        // æ”¯ä»˜æˆåŠŸï¼Œè·³è½¬åˆ°æˆåŠŸé¡µé¢
        router.replaceUrl({
          url: 'pages/CheckoutSuccessPage',
          params: {
            orderId: result.orderId,
            totalPrice: this.totalPrice
          }
        });
      } else {
        promptAction.showToast({
          message: result.message,
          duration: 2000
        });
      }
    } catch (error) {
      console.error('Payment failed:', error);
      promptAction.showToast({
        message: 'æ”¯ä»˜å¤±è´¥ï¼Œè¯·é‡è¯•',
        duration: 2000
      });
    } finally {
      this.isLoading = false;
    }
  }

  /**
   * æ„å»ºUIç•Œé¢
   */
  build() {
    Stack() {
      // ä¸»è¦å†…å®¹
      Column() {
      // æ ‡é¢˜æ 
      Row() {
        Button() {
          Text('â†')
            .fontSize(20)
            .fontColor('#333')
            .fontWeight(FontWeight.Bold)
        }
        .width(40)
        .height(40)
        .backgroundColor('transparent')
        .onClick(() => router.back())

        Text('ç¡®è®¤è®¢å•')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333')
          .layoutWeight(1)
          .textAlign(TextAlign.Center)

        // å ä½ï¼Œä¿æŒæ ‡é¢˜å±…ä¸­
        Row().width(40).height(40)
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#fff')

      Scroll() {
        Column() {
          // æ”¶è´§åœ°å€åŒºåŸŸ
          Column() {
            Row() {
              Text('ğŸ ')
                .fontSize(16)
                .margin({ right: 8 })

              Text('æ”¶è´§åœ°å€')
                .fontSize(16)
                .fontWeight(FontWeight.Medium)
                .fontColor('#333')
                .layoutWeight(1)

              Text('â†’')
                .fontSize(14)
                .fontColor('#ccc')
            }
            .width('100%')
            .margin({ bottom: 12 })

            if (this.selectedAddress) {
              Column() {
                Row() {
                  Text(this.selectedAddress.recipientName)
                    .fontSize(16)
                    .fontColor('#333')
                    .margin({ right: 12 })

                  Text(this.selectedAddress.phone)
                    .fontSize(14)
                    .fontColor('#666')
                }
                .width('100%')
                .margin({ bottom: 8 })

                Text(this.selectedAddress.fullAddress)
                  .fontSize(14)
                  .fontColor('#666')
                  .width('100%')
                  .textAlign(TextAlign.Start)
              }
              .alignItems(HorizontalAlign.Start)
            } else {
              Text('è¯·é€‰æ‹©æ”¶è´§åœ°å€')
                .fontSize(14)
                .fontColor('#999')
                .width('100%')
                .textAlign(TextAlign.Start)
            }
          }
          .width('100%')
          .padding(16)
          .backgroundColor('#fff')
          .borderRadius(8)
          .margin({ top: 12, left: 16, right: 16, bottom: 12 })
          .onClick(() => this.selectAddress())

          // å•†å“åˆ—è¡¨
          Column() {
            Row() {
              Text('ğŸ›ï¸')
                .fontSize(16)
                .margin({ right: 8 })

              Text('å•†å“æ¸…å•')
                .fontSize(16)
                .fontWeight(FontWeight.Medium)
                .fontColor('#333')
            }
            .width('100%')
            .margin({ bottom: 12 })

            ForEach(this.cartItems, (item: CartItem) => {
              Row() {
                Image(item.product.image)
                  .width(60)
                  .height(60)
                  .objectFit(ImageFit.Contain)
                  .backgroundColor('#f9f9f9')
                  .borderRadius(8)
                  .margin({ right: 12 })

                Column() {
                  Text(item.product.name)
                    .fontSize(14)
                    .fontColor('#333')
                    .maxLines(2)
                    .textOverflow({ overflow: TextOverflow.Ellipsis })
                    .width('100%')
                    .margin({ bottom: 4 })

                  Row() {
                    Text(`Â¥${item.product.price.toFixed(2)}`)
                      .fontSize(16)
                      .fontColor('#E41F19')
                      .fontWeight(FontWeight.Medium)

                    Blank()

                    Text(`x${item.quantity}`)
                      .fontSize(14)
                      .fontColor('#666')
                  }
                  .width('100%')
                }
                .layoutWeight(1)
                .alignItems(HorizontalAlign.Start)
              }
              .width('100%')
              .padding({ top: 12, bottom: 12 })
              .border({ width: { bottom: 1 }, color: '#f0f0f0' })
            }, (item: CartItem) => `${item.product.id}`)
          }
          .width('100%')
          .padding(16)
          .backgroundColor('#fff')
          .borderRadius(8)
          .margin({ left: 16, right: 16, bottom: 12 })

          // ä»·æ ¼æ˜ç»†
          Column() {
            Row() {
              Text('å•†å“æ€»ä»·')
                .fontSize(14)
                .fontColor('#666')

              Blank()

              Text(`Â¥${this.totalPrice.toFixed(2)}`)
                .fontSize(14)
                .fontColor('#333')
            }
            .width('100%')
            .margin({ bottom: 8 })

            Row() {
              Text('è¿è´¹')
                .fontSize(14)
                .fontColor('#666')

              Blank()

              Text('å…è¿è´¹')
                .fontSize(14)
                .fontColor('#4CAF50')
            }
            .width('100%')
            .margin({ bottom: 12 })

            Divider().color('#f0f0f0').margin({ bottom: 12 })

            Row() {
              Text('å®ä»˜æ¬¾')
                .fontSize(16)
                .fontWeight(FontWeight.Medium)
                .fontColor('#333')

              Blank()

              Text(`Â¥${this.totalPrice.toFixed(2)}`)
                .fontSize(18)
                .fontWeight(FontWeight.Bold)
                .fontColor('#E41F19')
            }
            .width('100%')
          }
          .width('100%')
          .padding(16)
          .backgroundColor('#fff')
          .borderRadius(8)
          .margin({ left: 16, right: 16, bottom: 80 })
        }
      }
      .layoutWeight(1)

      // åº•éƒ¨æ”¯ä»˜æ 
      Row() {
        Column() {
          Text('å®ä»˜æ¬¾')
            .fontSize(12)
            .fontColor('#666')

          Text(`Â¥${this.totalPrice.toFixed(2)}`)
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#E41F19')
        }
        .alignItems(HorizontalAlign.Start)

        Blank()

        Button(this.isLoading ? 'æ”¯ä»˜ä¸­...' : 'ç¡®è®¤æ”¯ä»˜')
          .width(120)
          .height(44)
          .backgroundColor('#E41F19')
          .fontColor('#fff')
          .fontSize(16)
          .borderRadius(22)
          .enabled(!this.isLoading)
          .onClick(() => this.openPaymentDialog())
      }
      .width('100%')
      .height(80)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#fff')
      .shadow({ radius: 8, color: 'rgba(0, 0, 0, 0.1)', offsetY: -2 })
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#f5f5f5')

      // æ”¯ä»˜æ–¹å¼é€‰æ‹©å¼¹çª—
      if (this.showPaymentDialog) {
        this.buildPaymentDialog()
      }
    }
    .width('100%')
    .height('100%')
  }

  /**
   * æ„å»ºæ”¯ä»˜æ–¹å¼é€‰æ‹©å¼¹çª—
   */
  @Builder
  buildPaymentDialog() {
    Stack() {
      // é®ç½©å±‚
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0, 0, 0, 0.5)')
        .onClick(() => this.closePaymentDialog())

      // å¼¹çª—å†…å®¹
      Column() {
        // å¼¹çª—é¡¶éƒ¨è£…é¥°æ¡
        Row()
          .width(40)
          .height(4)
          .backgroundColor('#e0e0e0')
          .borderRadius(2)
          .margin({ top: 12, bottom: 16 })

        // å¼¹çª—æ ‡é¢˜
        Row() {
          Column() {
            Text('é€‰æ‹©æ”¯ä»˜æ–¹å¼')
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor('#333')
              .margin({ bottom: 4 })

            Text('è¯·é€‰æ‹©æ‚¨çš„æ”¯ä»˜æ–¹å¼')
              .fontSize(14)
              .fontColor('#666')
          }
          .alignItems(HorizontalAlign.Start)
          .layoutWeight(1)

          Button() {
            Text('Ã—')
              .fontSize(18)
              .fontColor('#999')
          }
          .width(36)
          .height(36)
          .backgroundColor('#f5f5f5')
          .borderRadius(18)
          .onClick(() => this.closePaymentDialog())
        }
        .width('100%')
        .padding({ left: 24, right: 24, bottom: 24 })

        // æ”¯ä»˜æ–¹å¼åˆ—è¡¨
        Column() {
          this.buildPaymentOption('å¾®ä¿¡æ”¯ä»˜', 'ğŸ’š', 'å¾®ä¿¡æ”¯ä»˜', '#1AAD19', false)
          this.buildPaymentOption('æ”¯ä»˜å®', '', 'æ”¯ä»˜å®', '#1677FF', true, 'https://bed.djxs.xyz/file/BQACAgUAAyEGAASVl6k_AAIE-2hJi_yPv17fizJwZ0qf7q4hTImPAAK4GAACTEFQViSAqI-IBgaXNgQ.png')
          this.buildPaymentOption('äº‘é—ªä»˜', 'ğŸ”´', 'äº‘é—ªä»˜', '#E6002D', false)
        }
        .padding({ left: 24, right: 24 })
        .margin({ bottom: 32 })

        // æ”¯ä»˜é‡‘é¢åŒºåŸŸ
        Column() {
          Row() {
            Text('æ”¯ä»˜é‡‘é¢')
              .fontSize(14)
              .fontColor('#666')
              .layoutWeight(1)

            Text(`Â¥${this.totalPrice.toFixed(2)}`)
              .fontSize(24)
              .fontWeight(FontWeight.Bold)
              .fontColor('#E41F19')
          }
          .width('100%')
          .padding({ left: 24, right: 24, top: 20, bottom: 20 })
        }
        .width('100%')
        .backgroundColor('#fafafa')
        .margin({ bottom: 24 })

        // æŒ‰é’®åŒºåŸŸ
        Row() {
          Button('å–æ¶ˆ')
            .width('calc(50% - 32vp)')
            .height(48)
            .backgroundColor('#f5f5f5')
            .fontColor('#666')
            .fontSize(16)
            .borderRadius(24)
            .onClick(() => this.closePaymentDialog())

          Button('ç¡®è®¤æ”¯ä»˜')
            .width('calc(50% - 32vp)')
            .height(48)
            .backgroundColor('#E41F19')
            .fontColor('#fff')
            .fontSize(16)
            .borderRadius(24)
            .onClick(() => {
              this.closePaymentDialog();
              this.processPayment();
            })
        }
        .width('100%')
        .padding({ left: 24, right: 24 })
        .justifyContent(FlexAlign.SpaceBetween)
      }
      .width('92%')
      .constraintSize({ maxWidth: 400 })
      .backgroundColor('#fff')
      .borderRadius(20)
      .shadow({ radius: 30, color: 'rgba(0, 0, 0, 0.15)', offsetY: 8 })
      .padding({ bottom: 24 })
    }
    .width('100%')
    .height('100%')
    .position({ x: 0, y: 0 })
    .zIndex(1000)
  }

  /**
   * æ„å»ºæ”¯ä»˜æ–¹å¼é€‰é¡¹
   */
  @Builder
  buildPaymentOption(title: string, icon: string, method: 'å¾®ä¿¡æ”¯ä»˜' | 'æ”¯ä»˜å®' | 'äº‘é—ªä»˜', brandColor: string, useImageIcon: boolean = false, imageUrl?: string) {
    Row() {
      // æ”¯ä»˜æ–¹å¼å›¾æ ‡å®¹å™¨
      Row() {
        if (useImageIcon && imageUrl) {
          Image(imageUrl)
            .width(24)
            .height(24)
            .objectFit(ImageFit.Contain)
            .onError(() => {
              console.error(`Failed to load payment icon: ${imageUrl}`);
            })
        } else {
          Text(icon)
            .fontSize(20)
            .fontColor('#fff')
        }
      }
      .width(40)
      .height(40)
      .backgroundColor(brandColor)
      .borderRadius(8)
      .justifyContent(FlexAlign.Center)
      .margin({ right: 16 })

      // æ”¯ä»˜æ–¹å¼ä¿¡æ¯
      Column() {
        Text(title)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333')
          .margin({ bottom: 2 })

        Text('å®‰å…¨å¿«æ·æ”¯ä»˜')
          .fontSize(12)
          .fontColor('#999')
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)

      // é€‰ä¸­çŠ¶æ€
      Row() {
        if (this.paymentMethod === method) {
          Text('âœ“')
            .fontSize(16)
            .fontColor('#fff')
            .fontWeight(FontWeight.Bold)
        }
      }
      .width(24)
      .height(24)
      .backgroundColor(this.paymentMethod === method ? '#E41F19' : '#f0f0f0')
      .borderRadius(12)
      .justifyContent(FlexAlign.Center)
    }
    .width('100%')
    .height(72)
    .padding({ left: 20, right: 20, top: 8, bottom: 8 })
    .backgroundColor(this.paymentMethod === method ? '#fff5f5' : '#fff')
    .border({
      width: this.paymentMethod === method ? 1 : 0,
      color: this.paymentMethod === method ? '#E41F19' : 'transparent'
    })
    .borderRadius(8)
    .margin({ bottom: 8 })
    .onClick(() => this.selectPaymentMethod(method))
  }
}
