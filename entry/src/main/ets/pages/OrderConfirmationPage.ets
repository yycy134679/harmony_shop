import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import { CartViewModel } from '../viewmodel/CartViewModel';
import { CartItem } from '../model/CartItem';
import { Address } from '../model/Address';
import common from '@ohos.app.ability.common';

/**
 * è®¢å•ç¡®è®¤é¡µé¢
 */
@Entry
@Component
struct OrderConfirmationPage {
  @State cartItems: CartItem[] = [];
  @State selectedAddress: Address | null = null;
  @State totalPrice: number = 0;
  @State isLoading: boolean = false;
  @State paymentMethod: 'å¾®ä¿¡æ”¯ä»˜' | 'æ”¯ä»˜å®' | 'äº‘é—ªä»˜' = 'å¾®ä¿¡æ”¯ä»˜';
  private cartViewModel: CartViewModel = new CartViewModel();

  async aboutToAppear() {
    try {
      await this.cartViewModel.init(getContext(this) as common.UIAbilityContext);

      // è·å–è´­ç‰©è½¦å•†å“
      this.cartItems = this.cartViewModel.getCartItems();
      this.totalPrice = this.cartViewModel.getTotalPrice();

      // æ£€æŸ¥æ˜¯å¦æœ‰ä¼ å…¥çš„é€‰ä¸­åœ°å€
      const params = router.getParams() as Record<string, Object>;
      if (params && params.selectedAddress) {
        this.selectedAddress = params.selectedAddress as Address;
      } else {
        // è·å–é»˜è®¤åœ°å€
        this.selectedAddress = await this.cartViewModel.getDefaultAddress();
      }

      // éªŒè¯è´­ç‰©è½¦
      const validation = this.cartViewModel.canCheckout();
      if (!validation.canCheckout) {
        promptAction.showToast({
          message: validation.message,
          duration: 2000
        });
        router.back();
      }
    } catch (error) {
      console.error('Failed to initialize OrderConfirmationPage:', error);
      promptAction.showToast({
        message: 'é¡µé¢åˆå§‹åŒ–å¤±è´¥',
        duration: 2000
      });
      router.back();
    }
  }

  /**
   * é€‰æ‹©æ”¶è´§åœ°å€
   */
  private selectAddress(): void {
    router.pushUrl({
      url: 'pages/AddressSelectionPage',
      params: {
        selectedAddressId: this.selectedAddress?.id || ''
      }
    });
  }

  /**
   * æ˜¾ç¤ºæ”¯ä»˜æ–¹å¼é€‰æ‹©å¯¹è¯æ¡†
   */
  private showPaymentDialog(): void {
    if (!this.selectedAddress) {
      promptAction.showToast({
        message: 'è¯·å…ˆé€‰æ‹©æ”¶è´§åœ°å€',
        duration: 2000
      });
      return;
    }

    ActionSheet.show({
      title: 'é€‰æ‹©æ”¯ä»˜æ–¹å¼',
      message: 'è¯·é€‰æ‹©æ‚¨çš„æ”¯ä»˜æ–¹å¼',
      sheets: [
        {
          title: 'å¾®ä¿¡æ”¯ä»˜',
          action: () => {
            this.paymentMethod = 'å¾®ä¿¡æ”¯ä»˜';
            this.processPayment();
          }
        },
        {
          title: 'æ”¯ä»˜å®',
          action: () => {
            this.paymentMethod = 'æ”¯ä»˜å®';
            this.processPayment();
          }
        },
        {
          title: 'äº‘é—ªä»˜',
          action: () => {
            this.paymentMethod = 'äº‘é—ªä»˜';
            this.processPayment();
          }
        }
      ]
    });
  }

  /**
   * å¤„ç†æ”¯ä»˜
   */
  private async processPayment(): Promise<void> {
    if (this.isLoading) return;

    if (!this.selectedAddress) {
      promptAction.showToast({
        message: 'è¯·å…ˆé€‰æ‹©æ”¶è´§åœ°å€',
        duration: 2000
      });
      return;
    }

    this.isLoading = true;
    try {
      // æ¨¡æ‹Ÿæ”¯ä»˜å»¶è¿Ÿ
      await new Promise<void>(resolve => setTimeout(resolve, 1500));

      // åˆ›å»ºè®¢å•
      const result = await this.cartViewModel.createOrderAndClearCart(
        this.selectedAddress,
        this.paymentMethod
      );

      if (result.success) {
        // æ”¯ä»˜æˆåŠŸï¼Œè·³è½¬åˆ°æˆåŠŸé¡µé¢
        router.replaceUrl({
          url: 'pages/CheckoutSuccessPage',
          params: {
            orderId: result.orderId,
            totalPrice: this.totalPrice
          }
        });
      } else {
        promptAction.showToast({
          message: result.message,
          duration: 2000
        });
      }
    } catch (error) {
      console.error('Payment failed:', error);
      promptAction.showToast({
        message: 'æ”¯ä»˜å¤±è´¥ï¼Œè¯·é‡è¯•',
        duration: 2000
      });
    } finally {
      this.isLoading = false;
    }
  }

  build() {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        Button() {
          Text('â†')
            .fontSize(20)
            .fontColor('#333')
            .fontWeight(FontWeight.Bold)
        }
        .width(40)
        .height(40)
        .backgroundColor('transparent')
        .onClick(() => router.back())

        Text('ç¡®è®¤è®¢å•')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333')
          .layoutWeight(1)
          .textAlign(TextAlign.Center)

        // å ä½ï¼Œä¿æŒæ ‡é¢˜å±…ä¸­
        Row().width(40).height(40)
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#fff')

      Scroll() {
        Column() {
          // æ”¶è´§åœ°å€åŒºåŸŸ
          Column() {
            Row() {
              Text('ğŸ ')
                .fontSize(16)
                .margin({ right: 8 })

              Text('æ”¶è´§åœ°å€')
                .fontSize(16)
                .fontWeight(FontWeight.Medium)
                .fontColor('#333')
                .layoutWeight(1)

              Text('â†’')
                .fontSize(14)
                .fontColor('#ccc')
            }
            .width('100%')
            .margin({ bottom: 12 })

            if (this.selectedAddress) {
              Column() {
                Row() {
                  Text(this.selectedAddress.recipientName)
                    .fontSize(16)
                    .fontColor('#333')
                    .margin({ right: 12 })

                  Text(this.selectedAddress.phone)
                    .fontSize(14)
                    .fontColor('#666')
                }
                .width('100%')
                .margin({ bottom: 8 })

                Text(this.selectedAddress.fullAddress)
                  .fontSize(14)
                  .fontColor('#666')
                  .width('100%')
                  .textAlign(TextAlign.Start)
              }
              .alignItems(HorizontalAlign.Start)
            } else {
              Text('è¯·é€‰æ‹©æ”¶è´§åœ°å€')
                .fontSize(14)
                .fontColor('#999')
                .width('100%')
                .textAlign(TextAlign.Start)
            }
          }
          .width('100%')
          .padding(16)
          .backgroundColor('#fff')
          .borderRadius(8)
          .margin({ top: 12, left: 16, right: 16, bottom: 12 })
          .onClick(() => this.selectAddress())

          // å•†å“åˆ—è¡¨
          Column() {
            Row() {
              Text('ğŸ›ï¸')
                .fontSize(16)
                .margin({ right: 8 })

              Text('å•†å“æ¸…å•')
                .fontSize(16)
                .fontWeight(FontWeight.Medium)
                .fontColor('#333')
            }
            .width('100%')
            .margin({ bottom: 12 })

            ForEach(this.cartItems, (item: CartItem) => {
              Row() {
                Image(item.product.image)
                  .width(60)
                  .height(60)
                  .objectFit(ImageFit.Contain)
                  .backgroundColor('#f9f9f9')
                  .borderRadius(8)
                  .margin({ right: 12 })

                Column() {
                  Text(item.product.name)
                    .fontSize(14)
                    .fontColor('#333')
                    .maxLines(2)
                    .textOverflow({ overflow: TextOverflow.Ellipsis })
                    .width('100%')
                    .margin({ bottom: 4 })

                  Row() {
                    Text(`Â¥${item.product.price.toFixed(2)}`)
                      .fontSize(16)
                      .fontColor('#E41F19')
                      .fontWeight(FontWeight.Medium)

                    Blank()

                    Text(`x${item.quantity}`)
                      .fontSize(14)
                      .fontColor('#666')
                  }
                  .width('100%')
                }
                .layoutWeight(1)
                .alignItems(HorizontalAlign.Start)
              }
              .width('100%')
              .padding({ top: 12, bottom: 12 })
              .border({ width: { bottom: 1 }, color: '#f0f0f0' })
            }, (item: CartItem) => `${item.product.id}`)
          }
          .width('100%')
          .padding(16)
          .backgroundColor('#fff')
          .borderRadius(8)
          .margin({ left: 16, right: 16, bottom: 12 })

          // ä»·æ ¼æ˜ç»†
          Column() {
            Row() {
              Text('å•†å“æ€»ä»·')
                .fontSize(14)
                .fontColor('#666')

              Blank()

              Text(`Â¥${this.totalPrice.toFixed(2)}`)
                .fontSize(14)
                .fontColor('#333')
            }
            .width('100%')
            .margin({ bottom: 8 })

            Row() {
              Text('è¿è´¹')
                .fontSize(14)
                .fontColor('#666')

              Blank()

              Text('å…è¿è´¹')
                .fontSize(14)
                .fontColor('#4CAF50')
            }
            .width('100%')
            .margin({ bottom: 12 })

            Divider().color('#f0f0f0').margin({ bottom: 12 })

            Row() {
              Text('å®ä»˜æ¬¾')
                .fontSize(16)
                .fontWeight(FontWeight.Medium)
                .fontColor('#333')

              Blank()

              Text(`Â¥${this.totalPrice.toFixed(2)}`)
                .fontSize(18)
                .fontWeight(FontWeight.Bold)
                .fontColor('#E41F19')
            }
            .width('100%')
          }
          .width('100%')
          .padding(16)
          .backgroundColor('#fff')
          .borderRadius(8)
          .margin({ left: 16, right: 16, bottom: 80 })
        }
      }
      .layoutWeight(1)

      // åº•éƒ¨æ”¯ä»˜æ 
      Row() {
        Column() {
          Text('å®ä»˜æ¬¾')
            .fontSize(12)
            .fontColor('#666')

          Text(`Â¥${this.totalPrice.toFixed(2)}`)
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#E41F19')
        }
        .alignItems(HorizontalAlign.Start)

        Blank()

        Button(this.isLoading ? 'æ”¯ä»˜ä¸­...' : 'ç¡®è®¤æ”¯ä»˜')
          .width(120)
          .height(44)
          .backgroundColor('#E41F19')
          .fontColor('#fff')
          .fontSize(16)
          .borderRadius(22)
          .enabled(!this.isLoading)
          .onClick(() => this.showPaymentDialog())
      }
      .width('100%')
      .height(80)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#fff')
      .shadow({ radius: 8, color: 'rgba(0, 0, 0, 0.1)', offsetY: -2 })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f5f5f5')
  }
}
