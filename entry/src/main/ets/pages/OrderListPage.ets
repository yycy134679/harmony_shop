import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import { OrderViewModel } from '../viewmodel/OrderViewModel';
import { OrderItem } from '../view/OrderItem';
import { Order } from '../model/Order';
import common from '@ohos.app.ability.common';

interface OrderStats {
  total: number;
  paid: number;
  completed: number;
}

/**
 * æˆ‘çš„è®¢å•é¡µé¢
 */
@Entry
@Component
struct OrderListPage {
  @State orders: Order[] = [];
  @State isLoading: boolean = true;
  @State orderStats: OrderStats = { total: 0, paid: 0, completed: 0 };
  private orderViewModel: OrderViewModel = new OrderViewModel();

  async aboutToAppear() {
    try {
      await this.orderViewModel.init(getContext(this) as common.UIAbilityContext);
      await this.loadOrders();
      await this.loadOrderStats();
    } catch (error) {
      console.error('Failed to initialize OrderListPage:', error);
      this.isLoading = false;
    }
  }

  /**
   * é¡µé¢æ˜¾ç¤ºæ—¶åˆ·æ–°æ•°æ®
   */
  async onPageShow() {
    // é¡µé¢æ˜¾ç¤ºæ—¶åˆ·æ–°è®¢å•æ•°æ®
    await this.refreshOrders();
  }

  /**
   * åŠ è½½è®¢å•åˆ—è¡¨
   */
  private async loadOrders(): Promise<void> {
    try {
      this.isLoading = true;
      this.orders = await this.orderViewModel.getOrders();
      // æŒ‰åˆ›å»ºæ—¶é—´å€’åºæ’åˆ—
      this.orders.sort((a, b) => b.createTime - a.createTime);
    } catch (error) {
      console.error('Failed to load orders:', error);
      promptAction.showToast({
        message: 'åŠ è½½è®¢å•å¤±è´¥',
        duration: 2000
      });
    } finally {
      this.isLoading = false;
    }
  }

  /**
   * åŠ è½½è®¢å•ç»Ÿè®¡ä¿¡æ¯
   */
  private async loadOrderStats(): Promise<void> {
    try {
      this.orderStats = await this.orderViewModel.getOrderStats();
    } catch (error) {
      console.error('Failed to load order stats:', error);
    }
  }

  /**
   * æŸ¥çœ‹è®¢å•è¯¦æƒ…
   */
  private viewOrderDetail(order: Order): void {
    router.pushUrl({
      url: 'pages/OrderDetailPage',
      params: { order: order }
    });
  }

  /**
   * åˆ·æ–°è®¢å•åˆ—è¡¨
   */
  private async refreshOrders(): Promise<void> {
    await this.loadOrders();
    await this.loadOrderStats();
  }

  build() {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        Button() {
          Text('â†')
            .fontSize(20)
            .fontColor('#333')
            .fontWeight(FontWeight.Bold)
        }
        .width(40)
        .height(40)
        .backgroundColor('#f0f0f0')
        .borderRadius(20)
        .onClick(() => router.back())

        Text('æˆ‘çš„è®¢å•')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333')
          .layoutWeight(1)
          .textAlign(TextAlign.Center)

        // åˆ·æ–°æŒ‰é’®
        Button() {
          Text('åˆ·æ–°')
            .fontSize(12)
            .fontColor('#666')
        }
        .height(32)
        .padding({ left: 8, right: 8 })
        .backgroundColor('#f0f0f0')
        .borderRadius(16)
        .onClick(() => this.refreshOrders())
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#fff')

      // è®¢å•ç»Ÿè®¡å¡ç‰‡
      if (!this.isLoading) {
        Row() {
          Column() {
            Text(this.orderStats.total.toString())
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor('#333')
              .margin({ bottom: 4 })

            Text('å…¨éƒ¨è®¢å•')
              .fontSize(12)
              .fontColor('#666')
          }
          .layoutWeight(1)

          Column() {
            Text(this.orderStats.paid.toString())
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor('#ff6b35')
              .margin({ bottom: 4 })

            Text('å·²æ”¯ä»˜')
              .fontSize(12)
              .fontColor('#666')
          }
          .layoutWeight(1)

          Column() {
            Text(this.orderStats.completed.toString())
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor('#4CAF50')
              .margin({ bottom: 4 })

            Text('å·²å®Œæˆ')
              .fontSize(12)
              .fontColor('#666')
          }
          .layoutWeight(1)
        }
        .width('100%')
        .padding(12)
        .backgroundColor('#fff')
        .margin({ top: 0, left: 16, right: 16, bottom: 0 })
        .borderRadius(8)
      }

      if (this.isLoading) {
        // åŠ è½½çŠ¶æ€
        Column() {
          LoadingProgress()
            .width(40)
            .height(40)
            .margin({ bottom: 16 })

          Text('åŠ è½½ä¸­...')
            .fontSize(14)
            .fontColor('#666')
        }
        .width('100%')
        .layoutWeight(1)
        .padding({ top: 60 })
        .justifyContent(FlexAlign.Start)
      } else if (this.orders.length === 0) {
        // ç©ºçŠ¶æ€
        Column() {
          Text('ğŸ“‹')
            .fontSize(60)
            .margin({ bottom: 16 })

          Text('æš‚æ— è®¢å•')
            .fontSize(16)
            .fontColor('#666')
            .margin({ bottom: 8 })

          Text('å¿«å»è´­ä¹°æ‚¨å–œæ¬¢çš„å•†å“å§')
            .fontSize(14)
            .fontColor('#999')
            .margin({ bottom: 24 })

          Button('å»è´­ç‰©')
            .width(120)
            .height(40)
            .backgroundColor('#ff6b35')
            .fontColor('#fff')
            .fontSize(16)
            .borderRadius(20)
            .onClick(() => {
              router.clear();
              router.pushUrl({ url: 'view/BottomTabs' });
            })
        }
        .width('100%')
        .layoutWeight(1)
        .padding({ top: 60 })
        .justifyContent(FlexAlign.Start)
      } else {
        // è®¢å•åˆ—è¡¨
        Scroll() {
          Column() {
            ForEach(this.orders, (order: Order) => {
              OrderItem({
                order: order,
                onViewDetail: (order: Order) => this.viewOrderDetail(order)
              })
            }, (order: Order) => order.orderId)
          }
          .width('100%')
          .alignItems(HorizontalAlign.Start)
          .justifyContent(FlexAlign.Start)
          .padding({ left: 16, right: 16, top: 8, bottom: 16 })
        }
        .width('100%')
        .height('100%')
        .layoutWeight(1)
        .align(Alignment.TopStart)
        .scrollable(ScrollDirection.Vertical)
        .scrollBar(BarState.Off)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f5f5f5')
    .alignItems(HorizontalAlign.Start)
    .justifyContent(FlexAlign.Start)
  }
}
