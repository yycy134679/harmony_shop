// 202306110141 æ¨å¯Œæ¶›
// ä¸ªäººä¸­å¿ƒé¡µé¢ - å±•ç¤ºç”¨æˆ·ä¿¡æ¯å’ŒåŠŸèƒ½èœå•ï¼Œæ”¯æŒç™»å½•ã€é€€å‡ºå’Œé¡µé¢è·³è½¬

import router from '@ohos.router';
import { Constants } from '../common/Constants';
import { UserViewModel } from '../viewmodel/UserViewModel';
import { ProfileViewModel } from '../viewmodel/ProfileViewModel';
import { User } from '../model/User';
import { Address } from '../model/Address';
import common from '@ohos.app.ability.common';

/**
 * ä¸ªäººä¸­å¿ƒé¡µé¢
 * å±•ç¤ºç”¨æˆ·ä¿¡æ¯å’ŒåŠŸèƒ½èœå•ï¼Œæ”¯æŒç™»å½•ã€é€€å‡ºå’Œé¡µé¢è·³è½¬
 */
@Entry
@Component
struct ProfilePage {
  @StorageLink(Constants.IS_LOGGED_IN) isLoggedIn: boolean = false; // ç™»å½•çŠ¶æ€
  @StorageLink(Constants.CURRENT_USER) currentUser: string = '';   // å½“å‰ç”¨æˆ·å
  @State userInfo: User | null = null; // ç”¨æˆ·è¯¦ç»†ä¿¡æ¯
  @State defaultAddress: Address | null = null; // é»˜è®¤åœ°å€
  @State isLoading: boolean = false; // åŠ è½½çŠ¶æ€
  private userViewModel: UserViewModel = new UserViewModel(); // ç”¨æˆ·è§†å›¾æ¨¡å‹ï¼ˆå¤„ç†ç™»å½•/é€€å‡ºï¼‰
  private profileViewModel: ProfileViewModel = new ProfileViewModel(); // ä¸ªäººä¸­å¿ƒè§†å›¾æ¨¡å‹

  /**
   * ç”Ÿå‘½å‘¨æœŸ aboutToAppear
   * åˆå§‹åŒ–è§†å›¾æ¨¡å‹ï¼Œå¹¶åŠ è½½ç”¨æˆ·æ•°æ®ï¼ˆå¦‚æœå·²ç™»å½•ï¼‰
   */
  async aboutToAppear() {
    try {
      await this.profileViewModel.init(getContext(this) as common.UIAbilityContext);
      if (this.isLoggedIn) {
        await this.loadUserData();
      }
    } catch (error) {
      console.error('Failed to initialize ProfilePage:', error);
    }
  }

  /**
   * åŠ è½½ç”¨æˆ·æ•°æ®
   * è·å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯å’Œé»˜è®¤åœ°å€
   */
  private async loadUserData(): Promise<void> {
    if (this.isLoading) return;

    this.isLoading = true;
    try {
      // è·å–ç”¨æˆ·ä¿¡æ¯
      this.userInfo = await this.profileViewModel.getCurrentUserInfo();
      // è·å–é»˜è®¤åœ°å€
      this.defaultAddress = await this.profileViewModel.getDefaultAddress();
    } catch (error) {
      console.error('Failed to load user data:', error);
    } finally {
      this.isLoading = false;
    }
  }

  /**
   * å¤„ç†é€€å‡ºç™»å½•
   * æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†ï¼Œç¡®è®¤åæ‰§è¡Œé€€å‡ºæ“ä½œ
   */
  private handleLogout(): void {
    AlertDialog.show({
      title: 'é€€å‡ºç™»å½•',
      message: 'ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ',
      primaryButton: {
        value: 'ç¡®å®š',
        action: () => {
          this.userViewModel.logout();
        }
      },
      secondaryButton: {
        value: 'å–æ¶ˆ',
        action: () => {}
      }
    });
  }

  /**
   * è·³è½¬åˆ°ç™»å½•é¡µé¢
   */
  private goToLogin(): void {
    router.pushUrl({ url: 'pages/LoginPage' });
  }

  /**
   * è·³è½¬åˆ°ç¼–è¾‘ä¸ªäººä¿¡æ¯é¡µé¢
   */
  private goToEditProfile(): void {
    router.pushUrl({
      url: 'pages/EditProfilePage'
    });
  }

  /**
   * é¡µé¢æ˜¾ç¤ºæ—¶çš„å›è°ƒ
   * æ¯æ¬¡é¡µé¢æ˜¾ç¤ºæ—¶é‡æ–°åŠ è½½ç”¨æˆ·æ•°æ®
   */
  onPageShow(): void {
    if (this.isLoggedIn) {
      this.loadUserData();
    }
  }

  /**
   * è·³è½¬åˆ°æˆ‘çš„æ”¶è—é¡µé¢
   */
  private goToFavorites(): void {
    router.pushUrl({ url: 'pages/FavoriteListPage' });
  }

  /**
   * è·³è½¬åˆ°åœ°å€ç®¡ç†é¡µé¢
   */
  private goToAddressManagement(): void {
    router.pushUrl({ url: 'pages/AddressManagementPage' });
  }

  /**
   * è·³è½¬åˆ°æˆ‘çš„è®¢å•é¡µé¢
   */
  private goToOrders(): void {
    router.pushUrl({ url: 'pages/OrderListPage' });
  }

  /**
   * æ„å»ºUIç•Œé¢
   */
  build() {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        Button() {
          Text('â†')
            .fontSize(20)
            .fontColor('#333')
            .fontWeight(FontWeight.Bold)
        }
        .width(40)
        .height(40)
        .backgroundColor('#f0f0f0')
        .borderRadius(20)
        .onClick(() => {
          // è¿”å›åˆ°é¦–é¡µï¼ˆåº•éƒ¨å¯¼èˆªï¼‰
          router.replaceUrl({ url: 'view/BottomTabs' });
        })

        Text('ä¸ªäººä¸­å¿ƒ')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333')
          .layoutWeight(1)
          .textAlign(TextAlign.Center)

        // å ä½ï¼Œä¿æŒæ ‡é¢˜å±…ä¸­
        Row().width(40).height(40)
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#fff')

      if (this.isLoggedIn) {
        // å·²ç™»å½•çŠ¶æ€
        this.buildLoggedInContent()
      } else {
        // æœªç™»å½•çŠ¶æ€
        this.buildNotLoggedInContent()
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f5f5f5')
  }

  /**
   * æ„å»ºå·²ç™»å½•çŠ¶æ€çš„å†…å®¹
   */
  @Builder
  buildLoggedInContent() {
    Column() {
      // ç”¨æˆ·ä¿¡æ¯åŒºåŸŸ
      Column() {
        // å¤´åƒ
        Text('ğŸ‘¤')
          .fontSize(60)
          .margin({ bottom: 12 })

        // ç”¨æˆ·å
        Text(this.currentUser)
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333')
          .margin({ bottom: 8 })

        // ä¸ªäººä¿¡æ¯å±•ç¤ºåŒºåŸŸ
        if (this.userInfo?.phone) {
          Text(`ç”µè¯ï¼š${this.userInfo.phone}`)
            .fontSize(14)
            .fontColor('#666')
            .margin({ bottom: 4 })
        }

        if (this.defaultAddress) {
          Text(`é»˜è®¤åœ°å€ï¼š${this.defaultAddress.fullAddress}`)
            .fontSize(14)
            .fontColor('#666')
            .maxLines(2)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
        } else {
          Text('é»˜è®¤åœ°å€ï¼šæœªè®¾ç½®')
            .fontSize(14)
            .fontColor('#999')
        }
      }
      .width('100%')
      .padding(24)
      .backgroundColor('#fff')
      .margin({ top: 12, bottom: 12 })

      // åŠŸèƒ½èœå•åŒºåŸŸ
      Column() {
        this.buildMenuItem('æˆ‘çš„è®¢å•', 'ğŸ“‹', () => this.goToOrders())
        Divider().color('#f0f0f0')
        this.buildMenuItem('æˆ‘çš„æ”¶è—', 'â¤ï¸', () => this.goToFavorites())
        Divider().color('#f0f0f0')
        this.buildMenuItem('åœ°å€ç®¡ç†', 'ğŸ ', () => this.goToAddressManagement())
        Divider().color('#f0f0f0')
        this.buildMenuItem('ä¿®æ”¹ä¿¡æ¯', 'ğŸ‘¤', () => this.goToEditProfile())
      }
      .backgroundColor('#fff')
      .borderRadius(8)
      .margin({ left: 16, right: 16, bottom: 24 })

      // é€€å‡ºç™»å½•æŒ‰é’®
      Button('é€€å‡ºç™»å½•')
        .width('calc(100% - 32vp)')
        .height(48)
        .backgroundColor('#ff4444')
        .fontColor('#fff')
        .fontSize(16)
        .borderRadius(8)
        .onClick(() => this.handleLogout())
    }
    .width('100%')
    .layoutWeight(1)
  }

  /**
   * æ„å»ºæœªç™»å½•çŠ¶æ€çš„å†…å®¹
   */
  @Builder
  buildNotLoggedInContent() {
    Column() {
      // æœªç™»å½•æç¤ºåŒºåŸŸ
      Column() {
        Text('ğŸ‘¤')
          .fontSize(60)
          .fontColor('#ccc')
          .margin({ bottom: 16 })

        Text('æ‚¨è¿˜æœªç™»å½•')
          .fontSize(18)
          .fontColor('#666')
          .margin({ bottom: 8 })

        Text('ç™»å½•åå¯äº«å—æ›´å¤šæœåŠ¡')
          .fontSize(14)
          .fontColor('#999')
          .margin({ bottom: 24 })

        Button('ç«‹å³ç™»å½•')
          .width(120)
          .height(40)
          .backgroundColor('#ff6b35')
          .fontColor('#fff')
          .fontSize(16)
          .borderRadius(20)
          .onClick(() => this.goToLogin())
      }
      .width('100%')
      .padding(48)
      .backgroundColor('#fff')
      .justifyContent(FlexAlign.Center)
      .margin({ top: 12 })
    }
    .width('100%')
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
  }

  /**
   * æ„å»ºèœå•é¡¹
   * @param title èœå•æ ‡é¢˜
   * @param icon èœå•å›¾æ ‡
   * @param onClick ç‚¹å‡»äº‹ä»¶
   */
  @Builder
  buildMenuItem(title: string, icon: string, onClick: () => void) {
    Row() {
      Text(icon)
        .fontSize(20)
        .margin({ right: 12 })

      Text(title)
        .fontSize(16)
        .fontColor('#333')
        .layoutWeight(1)

      Text('â†’')
        .fontSize(14)
        .fontColor('#ccc')
    }
    .width('100%')
    .height(56)
    .padding({ left: 16, right: 16 })
    .onClick(onClick)
  }
}
